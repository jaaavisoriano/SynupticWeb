---
const navItems = [
  { href: '/medical-writing/', label: 'Medical Writing' },
  { href: '/estrategia-healthcare/', label: 'Estrategia Healthcare' },
  { href: '/asi-trabajamos/', label: 'As√≠ Trabajamos' },
  { href: '/synupteam/', label: 'SynupTeam' },
  { href: '/dudas-razonables/', label: 'Dudas razonables' },
];

const currentPath = Astro.url.pathname;
---

<div id="header_container" class="cesis_opaque_header">
  <header id="cesis_header" class="top-header cesis_sticky cesis_header_shrink cesis_header_shadow">
    <div class="header_main">
      <div class="cesis_container">
        <div class="header_logo logo_left">
          <div id="logo_img">
            <a href="/">
              <img 
                class="desktop_logo" 
                src="/images/logo.webp" 
                alt="Synuptic" 
                title="Synuptic" 
                width="200" 
                height="72"
              >
            </a>
          </div>
        </div>
        
        <div class="cesis_menu_button cesis_mobile_menu_switch" id="mobile-menu-toggle">
          <span class="lines"></span>
        </div>
        
        <nav id="site-navigation" class="tt-main-navigation logo_left menu_center">
          <div class="menu-main-ct">
            <ul id="main-menu" class="main-menu sm smart_menu">
              {navItems.map((item) => (
                <li class={currentPath === item.href ? 'current-menu-item' : ''}>
                  <a href={item.href}><span>{item.label}</span></a>
                </li>
              ))}
              
              <!-- Social Icons Integrated -->
              <li class="menu-item-icon">
                <a 
                  href="https://www.linkedin.com/company/synuptic/" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  aria-label="LinkedIn"
                  class="social-icon-link"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                  </svg>
                </a>
              </li>
              <li class="menu-item-icon">
                <a 
                  href="/#contact" 
                  aria-label="Contact via Email"
                  class="social-icon-link"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                  </svg>
                </a>
              </li>
              <li class="menu-item-icon">
                <button 
                  id="theme-toggle-desktop" 
                  class="social-icon-link theme-toggle" 
                  aria-label="Toggle Dark Mode"
                >
                  <!-- Moon (Show in Light Mode) -->
                  <svg class="moon-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                  </svg>
                  <!-- Sun (Show in Dark Mode) -->
                  <svg class="sun-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                  </svg>
                </button>
              </li>
            </ul>
          </div>
        </nav>
      </div>
    </div>
    
    <!-- Mobile menu overlay for closing when clicking outside -->
    <div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>
    
    <div class="header_mobile" id="mobile-nav">
      <nav id="mobile-navigation" class="tt-mobile-navigation">
        <div class="menu-mobile-ct">
          <ul id="mobile-menu" class="mobile-menu">
            {navItems.map((item) => (
              <li class={currentPath === item.href ? 'current-menu-item' : ''}>
                <a href={item.href}><span>{item.label}</span></a>
              </li>
            ))}
          </ul>
        </div>
      </nav>
      <div class="tt-mobile-additional">
        <span class="cesis_social_icons cesis_simple">
          <a 
            href="https://www.linkedin.com/company/synuptic/" 
            target="_blank" 
            rel="noopener noreferrer"
            aria-label="LinkedIn"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
            </svg>
          </a>
        </span>
        <span class="cesis_social_icons cesis_simple" style="margin-left: 10px;">
          <button 
            id="theme-toggle-mobile" 
            class="social-icon-link theme-toggle" 
            aria-label="Toggle Dark Mode"
          >
            <!-- Moon (Show in Light Mode) -->
            <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
            <!-- Sun (Show in Dark Mode) -->
            <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
          </button>
        </span>
      </div>
    </div>
  </header>
</div>

<script>
  // Mobile menu toggle - compatible with View Transitions
  function initMobileMenu() {
    const menuToggle = document.getElementById('mobile-menu-toggle');
    const mobileNav = document.getElementById('mobile-nav');
    
    if (!menuToggle || !mobileNav) return;
    
    // Helper to get scrollbar width
    const getScrollbarWidth = () => {
      return window.innerWidth - document.documentElement.clientWidth;
    };

    // Clean up any existing state from previous navigation
    menuToggle.classList.remove('open');
    mobileNav.classList.remove('is-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
    
    // Remove old listeners by cloning the element
    const newMenuToggle = menuToggle.cloneNode(true) as HTMLElement;
    if (menuToggle.parentNode) {
      menuToggle.parentNode.replaceChild(newMenuToggle, menuToggle);
    }
    
    // Add fresh event listener
    // Add fresh event listener
    const toggleMenu = () => {
      const isOpen = newMenuToggle.classList.toggle('open');
      mobileNav.classList.toggle('is-open');
      
      const overlay = document.getElementById('mobile-menu-overlay');
      if (overlay) {
        overlay.classList.toggle('is-visible', isOpen);
      }
      
      if (isOpen) {
        // Lock scroll and compensate for scrollbar
        const scrollbarWidth = getScrollbarWidth();
        if (scrollbarWidth > 0) {
          document.body.style.paddingRight = `${scrollbarWidth}px`;
        }
        document.body.style.overflow = 'hidden';
      } else {
        // Unlock scroll
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      }
    };
    
    newMenuToggle.addEventListener('click', toggleMenu);
    
    // Close menu when clicking on overlay
    const overlay = document.getElementById('mobile-menu-overlay');
    if (overlay) {
      // Remove old listener if any (by cloning)
      const newOverlay = overlay.cloneNode(true) as HTMLElement;
      if (overlay.parentNode) {
        overlay.parentNode.replaceChild(newOverlay, overlay);
      }
      
      newOverlay.addEventListener('click', () => {
        if (mobileNav.classList.contains('is-open')) {
          toggleMenu();
        }
      });
    }
    
    // Close menu when clicking on a link (for smooth navigation)
    const mobileLinks = mobileNav.querySelectorAll('a');
    mobileLinks.forEach(link => {
      link.addEventListener('click', () => {
        newMenuToggle.classList.remove('open');
        mobileNav.classList.remove('is-open');
        const overlay = document.getElementById('mobile-menu-overlay');
        if (overlay) overlay.classList.remove('is-visible');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      });
    });
  }
  
  // Sticky header shadow on scroll
  function initHeaderScroll() {
    const header = document.getElementById('cesis_header');
    if (!header) return;
    
    // Use passive listener for better scroll performance
    window.addEventListener('scroll', () => {
      if (window.scrollY > 50) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    }, { passive: true });
  }
  
  // Initialize on first load
  initMobileMenu();
  initHeaderScroll();
  
  // Re-initialize after View Transitions navigation
  document.addEventListener('astro:page-load', () => {
    initMobileMenu();
    initHeaderScroll();
    initTheme();
  });

  // Theme Toggle Logic
  function initTheme() {
    const desktopToggle = document.getElementById('theme-toggle-desktop');
    const mobileToggle = document.getElementById('theme-toggle-mobile');
    
    // Check local storage
    const storedTheme = localStorage.getItem('theme');
    
    // Apply initial theme
    if (storedTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
    } else {
      document.documentElement.removeAttribute('data-theme');
    }

    // Toggle Handler
    const handleToggle = () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      if (newTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
      } else {
        document.documentElement.removeAttribute('data-theme');
      }
      
      localStorage.setItem('theme', newTheme);
    };

    // Attach listeners (cloning to prevent duplicates on re-renders if needed, though ViewTransitions handle full swap usually)
    // Actually, simple addEventListener is fine if we are careful, but let's use the clone pattern if we want to be safe, 
    // OR just removeEventListener first. For simplicity in this context:
    
    [desktopToggle, mobileToggle].forEach(btn => {
      if (btn) {
        // Remove old listener if any (not easily possible with anonymous functions without strict tracking)
        // So we'll use the .onclick property for a quick "clean" attachment or clone.
        // Let's use the clone method which is robust for Astro transitions re-runs.
        const newBtn = btn.cloneNode(true) as HTMLElement;
        if (btn.parentNode) {
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.addEventListener('click', handleToggle);
        }
      }
    });
  }

  // Run immediately to avoid FOUC (Flash of Unstyled Content) if possible
  // Ideally this script runs blocking in head, but here it's deferred. 
  // We'll rely on the re-run to catch it quickly.
  initTheme();
</script>

<style>
  /* Styling for icons inside the menu */
  .menu-item-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 8px;
  }

  .social-icon-link {
    display: flex !important;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    padding: 0 !important; /* Override default text padding */
    border-radius: 50%;
    background: var(--color-primary);
    color: var(--color-white) !important;
    transition: all 0.3s ease;
  }

  .social-icon-link span::after {
    display: none !important; /* Remove underline effect */
  }

  /* Override the default menu hover effect for these specific items if needed */
  .main-menu .menu-item-icon a:hover {
    background: var(--color-accent);
    color: var(--color-white) !important;
    transform: scale(1.1);
  }
  
  .social-icon-link svg {
    margin: 0;
  }

  /* Theme Toggle Styles */
  .theme-toggle {
    border: none;
    cursor: pointer;
    background: var(--color-primary);
    color: var(--color-white);
  }
  
  .theme-toggle:hover {
     background: var(--color-accent);
  }

  .theme-toggle .sun-icon { display: none; }
  .theme-toggle .moon-icon { display: block; }

  /* Global selector for theme state to toggle icons */
  :global([data-theme="dark"]) .theme-toggle .sun-icon { display: block; }
  :global([data-theme="dark"]) .theme-toggle .moon-icon { display: none; }

  /* Mobile Menu Overlay */
  .mobile-menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black */
    z-index: 99998; /* Below mobile menu (99999) but above everything else */
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    backdrop-filter: blur(2px); /* Optional: blur background slightly */
  }

  .mobile-menu-overlay.is-visible {
    opacity: 1;
    visibility: visible;
  }
  
  /* Ensure mobile nav is above overlay */
  .header_mobile {
    z-index: 99999;
  }
